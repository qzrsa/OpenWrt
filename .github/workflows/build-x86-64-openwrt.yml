name: OpenWrt x86/64 è‡ªåŠ¨ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      æºç ç‰ˆæœ¬:
        description: 'é€‰æ‹©OpenWrtç‰ˆæœ¬'
        required: true
        default: '24.10'
        type: choice
        options: [24.10]

      ç›®æ ‡è®¾å¤‡:
        description: 'é€‰æ‹©ç¼–è¯‘è®¾å¤‡'
        required: true
        default: 'x86-64'
        type: choice
        options: [x86-64]

      é»˜è®¤IP:
        description: 'è®¾ç½®ç™»å½•IPåœ°å€'
        required: false
        default: '192.168.11.1'

      åˆ†åŒºå¤§å°:
        description: 'è®¾ç½®rootfsåˆ†åŒºå¤§å°(MB)'
        required: false
        default: '800'

      å·¥å…·é“¾ç¼“å­˜:
        description: 'å¯ç”¨å·¥å…·é“¾ç¼“å­˜åŠ é€Ÿ'
        required: false
        default: true
        type: boolean

      ç»ˆç«¯å·¥å…·:
        description: 'å®‰è£…ZSHç»ˆç«¯å·¥å…·'
        required: false
        default: true
        type: boolean

      ä¸Šä¼ äº§ç‰©:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifact'
        required: false
        default: true
        type: boolean

      å‘å¸ƒç‰ˆæœ¬:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Releases'
        required: false
        default: true
        type: boolean

jobs:
  ç¼–è¯‘ä»»åŠ¡:
    runs-on: ubuntu-22.04
    name: ç¼–è¯‘ ${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }} ${{ github.event.inputs.æºç ç‰ˆæœ¬ }}
    
    env:
      é»˜è®¤IP: ${{ github.event.inputs.é»˜è®¤IP }}
      åˆ†åŒºå¤§å°: ${{ github.event.inputs.åˆ†åŒºå¤§å° }}
      å¯ç”¨å·¥å…·é“¾: ${{ github.event.inputs.å·¥å…·é“¾ç¼“å­˜ }}
      å®‰è£…ç»ˆç«¯å·¥å…·: ${{ github.event.inputs.ç»ˆç«¯å·¥å…· }}
      é…ç½®æ–‡ä»¶: configs/${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }}-${{ github.event.inputs.æºç ç‰ˆæœ¬ }}.config
      ç¼–è¯‘è„šæœ¬: diy-${{ github.event.inputs.æºç ç‰ˆæœ¬ }}.sh
      å·¥å…·é“¾æ ‡ç­¾: toolchain
      ä¸Šä¼ äºŒè¿›åˆ¶: false
      æ—¶åŒº: Asia/Shanghai
      æºç åˆ†æ”¯: openwrt-24.10
      # æ–°å¢è·¯å¾„å˜é‡
      å·¥ä½œç›®å½•: ${{ github.workspace }}
      OpenWrtè·¯å¾„: ${{ github.workspace }}/openwrt

    steps:
    - name: è·å–æºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: ç³»ç»Ÿæ€§èƒ½æ£€æŸ¥
      run: |
        echo "âš ï¸ æ€§èƒ½æç¤ºï¼šæ’ä»¶è¿‡å¤šå¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥"
        echo "==========================CPUä¿¡æ¯=========================="
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "CPUå‹å·: $(lscpu | grep "Model name" | cut -d: -f2 | sed 's/^ *//')"
        echo "==========================å†…å­˜ä¿¡æ¯=========================="
        free -h
        echo "==========================ç£ç›˜ä¿¡æ¯=========================="
        df -hT

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†ç³»ç»Ÿèµ„æº
        sudo swapoff -a
        sudo rm -f /swapfile
        
        # å®‰è£…å¿…è¦ä¾èµ–
        sudo apt-get update
        sudo apt-get install -y zstd build-essential clang libssl3 liblua5.4-dev
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$æ—¶åŒº"
        
        # è®¾ç½®æ–‡ä»¶æƒé™
        chmod +x $ç¼–è¯‘è„šæœ¬
        chmod +x scripts/*

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        echo "=== æ–‡ä»¶éªŒè¯ ==="
        echo "æ£€æŸ¥ç¼–è¯‘è„šæœ¬: $ç¼–è¯‘è„šæœ¬"
        [ -f "$ç¼–è¯‘è„šæœ¬" ] || (echo "é”™è¯¯ï¼šç¼–è¯‘è„šæœ¬ä¸å­˜åœ¨"; exit 1)
        
        echo "æ£€æŸ¥é…ç½®æ–‡ä»¶: $é…ç½®æ–‡ä»¶"
        [ -f "$é…ç½®æ–‡ä»¶" ] || (echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"; exit 1)
        
        echo "=== é…ç½®é¢„è§ˆ ==="
        head -n 20 $é…ç½®æ–‡ä»¶

    - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬
      run: |
        echo "å¼€å§‹ç¼–è¯‘ ${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }} è®¾å¤‡å›ºä»¶"
        ./$ç¼–è¯‘è„šæœ¬
        
    - name: ç¼–è¯‘å›ºä»¶
      id: firmware_compile
      run: |
        cd $OpenWrtè·¯å¾„
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
        make -j$(nproc) || make -j1 V=s
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "ç¼–è¯‘æ—¥æœŸ=$(date +"%Y-%m-%d")" >> $GITHUB_ENV
        echo "å‘å¸ƒæ—¶é—´=$(date +"%Y%m%d-%H%M")" >> $GITHUB_ENV
        echo "å›ºä»¶ç‰ˆæœ¬=$(cat version.date)" >> $GITHUB_ENV
        echo "å‘å¸ƒæ ‡ç­¾=${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }}-${{ github.event.inputs.æºç ç‰ˆæœ¬ }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: steps.firmware_compile.conclusion == 'success'
      run: |
        cd $OpenWrtè·¯å¾„/bin/targets/*/*
        echo "=== å›ºä»¶æ–‡ä»¶åˆ—è¡¨ ==="
        ls -lh
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -zcf packages.tar.gz packages
        echo "å›ºä»¶ç›®å½•=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ åˆ°äº§ç‰©(Artifacts)
      if: steps.firmware_compile.conclusion == 'success' && github.event.inputs.ä¸Šä¼ äº§ç‰© == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }}-å›ºä»¶
        path: ${{ env.å›ºä»¶ç›®å½• }}
        retention-days: 7

    - name: å‘å¸ƒåˆ°ç‰ˆæœ¬(Releases)
      if: steps.firmware_compile.conclusion == 'success' && github.event.inputs.å‘å¸ƒç‰ˆæœ¬ == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.å‘å¸ƒæ ‡ç­¾ }}
        name: "OpenWrt ${{ env.å›ºä»¶ç‰ˆæœ¬ }} - ${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }}"
        body: |
          ### ğŸš€ OpenWrt è‡ªåŠ¨ç¼–è¯‘ç‰ˆæœ¬
          **è®¾å¤‡æ¶æ„**: ${{ github.event.inputs.ç›®æ ‡è®¾å¤‡ }}
          **æºç ç‰ˆæœ¬**: ${{ github.event.inputs.æºç ç‰ˆæœ¬ }}
          **ç¼–è¯‘æ—¥æœŸ**: ${{ env.ç¼–è¯‘æ—¥æœŸ }}
          
          **é»˜è®¤ç™»å½•**: 
          - IPåœ°å€: ${{ github.event.inputs.é»˜è®¤IP }}
          - ç”¨æˆ·å: root
          - å¯†ç : (æ— )
          
          **åŒ…å«åŠŸèƒ½**:
          - æœ€æ–°å®‰å…¨æ›´æ–°
          - ä¼˜åŒ–ç½‘ç»œæ€§èƒ½
          - æ”¯æŒDockerå®¹å™¨
        files: |
          ${{ env.å›ºä»¶ç›®å½• }}/*.img.gz
          ${{ env.å›ºä»¶ç›®å½• }}/*.rootfs.tar.gz
          ${{ env.å›ºä»¶ç›®å½• }}/packages.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
